include ../common.mak
include ../commonp.mak

CRDATE := $(shell date +%s)

CUSTOMPFLAGS=-DCRDATE=$(CRDATE) -I. -Wno-multichar -I../libpit -I../libemulation -DARMEMU -ffreestanding \
    $(HEAP_DEBUG) $(LOGTRAP) $(GIT_COMMIT_ID) $(GIT_NOT_CLEAN) $(GIT_TAG_NAME)

GPSLIB_SOURCE=GPSLib68K.c

GPDLIB_SOURCE=GPDLib.c

ARM_SOURCE=armem.c armemu.c CPU.c icache.c MMU.c RAM.c \
        pxa_IC.c cp15.c

DARM_SOURCE=armv7.c armv7-tbl.c darm.c darm-tbl.c thumb.c \
         thumb2.c thumb2-decoder.c thumb2-tbl.c thumb-tbl.c

EMU_SOURCE=emupalmos.c armsyscall.c omtrap.c pinstrap.c hdtrap.c serialtrap.c fstrap.c intltrap.c \
        flpemtrap.c flptrap.c accessortrap.c expansiontrap.c tsmtrap.c lmtrap.c navtrap.c netlibtrap.c gpdlibtrap.c \
        systrap.c m68kcpu.c softfloat.c m68kops.c disasm.c \
        emu_notif_serde.c emu_launch_serde.c $(ARM_SOURCE) $(DARM_SOURCE) emulator.c

TOS_SOURCE=tos.c gemdos_impl.c bios_impl.c xbios_impl.c vdi.c aes.c

GLUE_SOURCE=BmpGlue.c CtlGlue.c DateGlue.c FldGlue.c FntGlue.c FrmGlue.c LstGlue.c MemGlue.c TblGlue.c TxtGlue.c WinGlue.c

SOURCE=notif_serde_wce.c launch_serde_wce.c build.c pumpkin.c pumpkin_syscall.c deploy.o storage.c script.c fill.c AboutBox.c AddressSortLib.c AlarmMgr.c AttentionMgr.c Bitmap.c CharAttr.c ColorTable.c BtLib.c Category.c Clipboard.c ConnectionMgr.c ConsoleMgr.c Control.c CPMLib68KInterface.c Crc.c DateTime.c Day.c DebugMgr.c DLServer.c Encrypt.c md5.c sha1.c ErrorBase.c Event.c ExgLib.c ExgMgr.c ExpansionMgr.c FatalAlert.c FeatureMgr.c Field.c FileStream.c Find.c FixedMath.c FloatMgr.c Font.c FontSelect.c Form.c FSLib.c Graffiti.c GraffitiReference.c GraffitiShift.c HAL.c HostControl.c IMCUtils.c INetMgr.c InsPoint.c IntlMgr.c IrLib.c Keyboard.c KeyMgr.c Launcher.c List.c LocaleMgr.c Localize.c Lz77Mgr.c Menu.c ModemMgr.c NetBitUtils.c NetMgr.c OverlayMgr.c Password.c PceNativeCall.c PdiLib.c PenInputMgr.c PenMgr.c PhoneLookup.c Preferences.c PrivateRecords.c Progress.c Rect.c ScrollBar.c SelTime.c SelDay.c SelTimeZone.c SerialLinkMgr.c SerialMgr.c SerialMgrOld.c SerialSdrv.c SerialVdrv.c SlotDrvrLib.c SoundMgr.c SslLib.c StringMgr.c SysEvtMgr.c SystemMgr.c SysUtils.c Table.c TelephonyMgr.c TextMgr.c TextServicesMgr.c TimeMgr.c UDAMgr.c UIColor.c UIControls.c UIResources.c VFSMgr.c VFSExplorer.c FileBrowser.c Window.c Chat.c cmheap.c grail.c wav.c dia.c taskbar.o wman.c peditor.c syntax.c edit.c RegistryMgr.c language.c calibrate.c unzip.c junzip.c puff.c plibc.c dosbox.c ssfn_font.c logtrap.c $(GLUE_SOURCE) $(GPSLIB_SOURCE) $(GPDLIB_SOURCE) $(EMU_SOURCE) $(TOS_SOURCE) kdtree.c

ifeq ($(OSNAME),Emscripten)

LAUNCHER=$(SRC)/Launcher
LAUNCHER_SOURCE=$(LAUNCHER)/Launcher.c $(LAUNCHER)/editstr.c $(LAUNCHER)/editbmp.c $(LAUNCHER)/editform.c $(LAUNCHER)/editbin.c $(LAUNCHER)/editsurf.c
LAUNCHER_OBJS=$(LAUNCHER_SOURCE:%.c=%.wasm)

PROGRAM=$(BIN)/libpumpkin.a
OBJS=$(SOURCE:%.c=%.wasm)
$(PROGRAM): $(OBJS) $(LAUNCHER_OBJS)
	@echo Creating libpumpkin.a
	@$(ARCMD) $(PROGRAM) $(OBJS) $(LAUNCHER_OBJS)

systrap.wasm: systrap.c switch.c
	@echo Compiling $<
	@$(EM_CC) $(CFLAGS) -c systrap.c -o systrap.wasm

else ifeq ($(OSNAME),Kernel)

LAUNCHER=$(SRC)/Launcher
LAUNCHER_SOURCE=$(LAUNCHER)/Launcher.c $(LAUNCHER)/editstr.c $(LAUNCHER)/editbmp.c $(LAUNCHER)/editform.c $(LAUNCHER)/editbin.c $(LAUNCHER)/editsurf.c
LAUNCHER_OBJS=$(LAUNCHER_SOURCE:%.c=%.o)

PROGRAM=$(BIN)/libpumpkin.a
OBJS=$(SOURCE:%.c=%.o)
$(PROGRAM): $(OBJS) $(LAUNCHER_OBJS)
	@echo Creating libpumpkin.a
	@$(ARCMD) $(PROGRAM) $(OBJS) $(LAUNCHER_OBJS)

systrap.o: systrap.c switch.c
	@echo Compiling $<
	@$(CC) $(CFLAGS) -c systrap.c -o systrap.o

else

PROGRAM=$(BIN)/libpumpkin$(SOEXT)
OBJS=$(SOURCE:%.c=%.o)
$(PROGRAM): $(OBJS)
	@echo Linking libpumpkin$(SOEXT)
	@$(CC) -shared -o $(PROGRAM) $(OBJS) $(EXTLIBS) -L$(BIN) -lpit -lm
	@$(STRIP) $(PROGRAM)

systrap.o: systrap.c switch.c
	@echo Compiling $<
	@$(CC) $(CFLAGS) -c systrap.c -o systrap.o

endif

ifneq ($(GIT_COMMIT_ID),)
build.o: build.c $(ROOT)/.git/HEAD $(ROOT)/.git/index
	@echo Compiling $<
	@$(CC) $(CFLAGS) -c -o $@ $<
endif

#notif_serde.c: notifications.struct launch_serde.c $(LIBPUMPKIN)/serde.sh
#	@echo Generating $@
#	@$(LIBPUMPKIN)/serde.sh notif $<

#emu_notif_serde.c: notifications.struct $(LIBPUMPKIN)/serde.sh
#	@echo Generating $@
#	@$(LIBPUMPKIN)/serde.sh notif $<

#launch_serde.c: launchcodes.struct $(LIBPUMPKIN)/serde.sh
#	@echo Generating $@
#	@$(LIBPUMPKIN)/serde.sh launch $<

#emu_launch_serde.c: launchcodes.struct $(LIBPUMPKIN)/serde.sh
#	@echo Generating $@
#	@$(LIBPUMPKIN)/serde.sh launch $<

logtrap.o: trapArgs_wce.c m68kdasm.c logtrap.c
	@echo Compiling logtrap.c
	@$(CC) $(CFLAGS) -c -o $@ logtrap.c

#trapArgs.c: traps.txt gen_log.sh
#	@echo Generating $@
#	@./gen_log.sh 0

clean:
	@rm -f $(PROGRAM) $(OBJS) $(LAUNCHER_OBJS)